{% extends "templates.html" %} {% block header %}
<title>Dashboard</title>
{% endblock %} {% block content %}
<div class="">
  <div class="row">
    <div class="x_panel">
      <div class="x_title">
        <h2>CPU & Memory</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="close-link"><i class="fa fa-close"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="row" id="cpu_table"> </div>
        <div style="width: 100%;">
          <div id="canvas_cpu" class="demo-placeholder" style="width: 100%; height: 270px;"></div>
        </div>
      </div>
    </div>
  </div>

  <br/>

  <div class="row">
    <div class="x_panel">
      <div class="x_title">
        <h2>GPU</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="close-link"><i class="fa fa-close"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content" id="gpu"></div>
    </div>
  </div>
  <br/>


  <div class="row">
    <div class="x_panel">
      <div class="x_title">
        <h2>Disks</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="close-link"><i class="fa fa-close"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content" style="display:block;">
        <div class="row" id="disks_table"></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="x_panel">
      <div class="x_title">
        <h2>Network</h2>
        <ul class="nav navbar-right panel_toolbox">
          <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
          <li><a class="close-link"><i class="fa fa-close"></i></a></li>
        </ul>
        <div class="clearfix"></div>
      </div>
      <div class="x_content" style="display:block;">
        <div id="speed_panel"></div>
        <div style="width: 100%;">
          <div id="canvas_net" class="demo-placeholder" style="width: 100%; height: 270px;"></div>
        </div>
      </div>
    </div>
  </div>


</div>



<!-- flot js -->
<!--[if lte IE 8]><script type="text/javascript" src="js/excanvas.min.js"></script><![endif]-->
<script type="text/javascript" src="/static/js/flot/jquery.flot.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.pie.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.orderBars.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.time.min.js"></script>
<script type="text/javascript" src="/static/js/flot/date.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.spline.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.stack.js"></script>
<script type="text/javascript" src="/static/js/flot/curvedLines.js"></script>
<script type="text/javascript" src="/static/js/flot/jquery.flot.resize.js"></script>
<script src="/static/js/pace/pace.min.js"></script>
<script>

  fresh_freq = 5000;
  queue_size = 300;
  gpu_not_set = true;

  from_time = new Date().getTime() / 1000 - 600;

  gpu_run_history = [];
  gpu_mem_history = [];
  net_history = [{'data': [], 'label': '  Upload KB/s',}, {'data': [], 'label': '  Download KB/s',}];
  cpu_mem_history = [{'data': [], 'label': '  CPU',}, {'data': [], 'label': '  Memory',}];
  
  time_zone = 8;

  plt_colors = [
    'rgba(200,0,0,1)', 'rgba(0,200,0,1)', 'rgba(0,0,200,1)',
    'rgba(200,200,0,1)', 'rgba(200,0,200,1)', 'rgba(0,200,200,1)',
  ]

  function history_control(history) {
    for (var each in history)
      while (history[each].data.length > queue_size)
        history[each].data.shift();
    return history;
  }
  
  

  function canvas_draw(name, data, color, max=null) {
    $(name).length && $.plot($(name), data, {
      series: {
        curvedLines: {
          apply: true,
          active: true,
          monotonicFit: true
        }
      },
      grid: {
        verticalLines: true,
        hoverable: true,
        clickable: true,
        tickColor: "#d5d5d5",
        borderWidth: 1,
        color: '#606060',
        borderWidth: {
          top: 0,
          right: 0,
          bottom: 0,
          left: 0,
        },
      },
      colors: plt_colors,
      xaxis: {
        tickColor: "rgba(51, 51, 51, 0.06)",
        mode: "time",
        axisLabelUseCanvas: true,
        axisLabelFontSizePixels: 12,
        axisLabelFontFamily: 'Verdana, Arial',
        axisLabelPadding: 10
      },
      yaxis: {
        min: 0,
        max: max,
        ticks: 8,
        tickColor: "rgba(51, 51, 51, 0.06)",
      },
      tooltip: false
    });
  }

  function random_color() {
    var r = Math.floor(Math.random() * 256);
    var g = Math.floor(Math.random() * 256);
    var b = Math.floor(Math.random() * 256);
    plt_colors.push('rgba(' + r + ',' + g + ',' + b + ',1)');
  }

  function get_color(x) {
    if (x > 70) return "red";
    if (x > 30) return "orange";
    return "green";
  }

  function concat(tables, split_num) {
    var tsplit = Math.floor(12 / split_num);
    var num = Math.ceil(tables.length / split_num);
    var html = '<div class="row">';
    var sub_html = [];
    for (var i = 0; i < split_num; i += 1) sub_html.push(`<div class="col-md-${tsplit} col-sm-6 col-xs-12 bg-white">`);
    for (var i = 0; i < tables.length; i += 1) sub_html[i%split_num] += tables[i];
    for (var i = 0; i < split_num; i += 1) {
      sub_html[i] += `</div>`;
      html += sub_html[i];
    }
    html += "</div>";
    return html;
  }

  function name_value_pattern(name, value, name_color='') {
    var color = get_color(value);
    return `
      <div class="">
        <div class="row">
          <div class="col-md-9 col-sm-9 col-xs-12">
            <span style="color:${name_color}">${name}</span>:
            <span style="color:${color}">${value}%</span>
          </div>
        </div>
        <div class="progress progress_sm" style="width: 100%;">
          <div class="progress-bar bg-${color}" role="progressbar" data-transitiongoal="80" aria-valuenow="79" style="width: ${value}%;">
          </div>
        </div>
      </div>
    `;
  }
  function name_value_usg_pattern(name, value, used, total, name_color='') {
    var color = get_color(value);
    return `
      <div class="">
        <div class="row">
          <div class="col-md-6 col-sm-6 col-xs-6">
            <span style="color:${name_color}">${name}</span>:
            <span style="color:${color}">${value}%</span>
          </div>
          <div class="col-md-6 col-sm-6 col-xs-6" align="right">
            <span style="color:${color}">${used}/${total}</span>
          </div>
        </div>
        <div class="progress progress_sm" style="width: 100%;">
          <div class="progress-bar bg-${color}" role="progressbar" data-transitiongoal="80" aria-valuenow="79" style="width: ${value}%;">
          </div>
        </div>
      </div>
    `
  }
  function disk_pattern(name, name2, value, used, total) {
    var color = get_color(value);
    return `
      <div class="">
        <div class="row">
          <div class="col-md-8 col-sm-8 col-xs-8">
            ${name}: <span style="color:${color}">${value}%</span> ${name2}
          </div>
          <div class="col-md-4 col-sm-4 col-xs-4" align="right">
            <span style="color:${color}">${used}/${total}</span>
          </div>
        </div>
        <div class="progress progress_sm" style="width: 100%;">
          <div class="progress-bar bg-${color}" role="progressbar" data-transitiongoal="80" aria-valuenow="79" style="width: ${value}%;">
          </div>
        </div>
      </div>
    `;
  }

  function ps() {
    $.ajax({
      url: '/ps',
      data: {'from_time': from_time,},
      type: 'get',
      dataType: 'json',
      success: function(res) {
        if (res.data.length == 0) return;

        var gpu_run_table = [];
        var gpu_mem_table = [];
        var cpu_table = [];
        var mem_table = [];
        var disks_table = [];

        for (var data_id in res.data) {
          var data = res.data[data_id].data;
          var time = (data.time + time_zone * 3600) * 1000;
          for (var gpu_num = gpu_run_history.length; gpu_num < data.gpu.length; gpu_num++) {
            gpu_run_history.push({'data': [], 'label': '  ' + data.gpu[gpu_num].name + ' ' + gpu_num,});
            gpu_mem_history.push({'data': [], 'label': '  ' + data.gpu[gpu_num].name + ' ' + gpu_num,});
          }
          for (var i = plt_colors.length; i < data.gpu.length; i++) random_color();
          net_history[0].data.push([time, data.net.sent_speed]);
          net_history[1].data.push([time, data.net.recv_speed]);
          cpu_mem_history[0].data.push([time, data.cpu_mean]);
          cpu_mem_history[1].data.push([time, data.memory.percent]);
          for (var i in data.gpu) {
            gpu = data.gpu[i];
            gpu_run_history[i].data.push([time, gpu.load])
            gpu_mem_history[i].data.push([time, gpu.percent])
          }
        }
        

        gpu_mem_history = history_control(gpu_mem_history);
        gpu_run_history = history_control(gpu_run_history);
        net_history = history_control(net_history);
        cpu_mem_history = history_control(cpu_mem_history);

        
        var data = res.data[res.data.length-1].data;
        for (var i in data.gpu) {
          var gpu = data.gpu[i];
          gpu_run_table.push(name_value_pattern(`${gpu.name} ${i}`, gpu.load, plt_colors[i]));
          gpu_mem_table.push(name_value_usg_pattern(`${gpu.name} ${i}`, gpu.percent, gpu.used, gpu.total, plt_colors[i]));
        }
        for (var i in data.cpu) {
          var cpu = data.cpu[i];
          cpu_table.push(name_value_pattern(`CPU ${i}`, cpu));
        }
        cpu_table.push(name_value_usg_pattern('Memory', data.memory.percent, data.memory.used, data.memory.total));
        cpu_table.push(name_value_usg_pattern('Swap', data.swap.percent, data.swap.used, data.swap.total));
        for (var i in data.disks) {
          var disk = data.disks[i];
          disks_table.push(disk_pattern(disk.device, disk.mountpoint, disk.percent, disk.used, disk.total));
        }

        if (data.gpu.length > 0) {
          if (gpu_not_set) {
            gpu_not_set = false;
            add_canvas();
          }
          canvas_draw("#canvas_gpu_mem", gpu_mem_history, plt_colors, max=100);
          canvas_draw("#canvas_gpu_run", gpu_run_history, plt_colors, max=100);
        } else {
          $("#gpu").html(data.gpu_msg);
          gpu_not_set = true;
        }
      
        var gpu_run_html = concat(gpu_run_table, 4);
        var gpu_mem_html = concat(gpu_mem_table, 4);
        var cpu_html = concat(cpu_table, 4);
        var mem_html = concat(mem_table, 3);
        var disks_html = concat(disks_table, 3);

        $("#gpu_run_table").html(gpu_run_html);
        $("#gpu_mem_table").html(gpu_mem_html);
        $("#cpu_table").html(cpu_html);
        $("#mem_table").html(mem_html);
        $("#disks_table").html(disks_html);

        canvas_draw("#canvas_cpu", cpu_mem_history, plt_colors, max=100);
        canvas_draw("#canvas_net", net_history, plt_colors);

        var gpu_usg_html = '';
        for (var each in data.gpups) {
          var p = data.gpups[each];
          gpu_usg_html += `
            <tr>
              <th>${p.gpu_id}</th>
              <td>${p.pid}</td>
              <td>${p.username}</td>
              <td>${p.cpu}%</td>
              <td>${p.memory}</td>
              <td>${p.gpu_memory}</td>
              <td>${p.name}</td>
            </tr>
          `;
        }
        $("#gpu_usg_table").html(gpu_usg_html);

        $("#speed_panel").html(`
          <div class="row" style="font-size: 16px;">
            <div class="col-md-6 col-sm-6 col-xs-6" align="left">
              Download Speed: <span style="color: #00aa00; font-size: 20px;"><strong>${data.net.recv_speed_t}/s</strong></span>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-6" align="left">
              Upload Speed: <span style="color: #aa0000; font-size: 20px;"><strong>${data.net.sent_speed_t}/s</strong></span>
            </div>
          </div>
          <hr/>
        `);
        from_time = data.time;

      },
      error: function() {

      }
    });
  }

  function add_canvas() {
    $("#gpu").html(`
      <div class="col-md-12 col-sm-12 col-xs-12">
        <h3>GPU Performance</h3>
        <div style="width: 100%;">
          <div id="canvas_gpu_run" class="demo-placeholder" style="width: 100%; height: 270px;"></div>
        </div>
        <br/>
        <div class="row" id="gpu_run_table"></div>
        <div class="clearfix"></div>
        <hr/>
      </div>
      <div class="col-md-12 col-sm-12 col-xs-12">
        <h3>GPU Memory</h3>
        <div style="width: 100%;">
          <div id="canvas_gpu_mem" class="demo-placeholder" style="width: 100%; height: 270px;"></div>
        </div>
        <br/>
        <div class="row" id="gpu_mem_table"></div>
        <div class="clearfix"></div>
        <hr/>
        </div>
      </div>
      <div class="col-md-12 col-sm-12 col-xs-12">
        <h3>GPU Usage</h3>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>GPU</th>
              <th>PID</th>
              <th>User</th>
              <th>CPU</th>
              <th>Memory</th>
              <th>GPU Memory</th>
              <th>Command</th>
            </tr>
            </thead>
            <tbody id="gpu_usg_table"></tbody>
          </table>
        <div class="clearfix"></div>
      </div>
    `);
  }
</script>
<script>
  NProgress.done();
  ps();
  setInterval("ps()", fresh_freq);
</script>
{% endblock %}
